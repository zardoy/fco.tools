class D{static read_bytes(e,r){const a=new D;return a.buf=e.getUint32(r,!0),a.buf_len=e.getUint32(r+4,!0),a}static read_bytes_array(e,r,a){const u=[];for(let t=0;t<a;t++)u.push(D.read_bytes(e,r+8*t));return u}}class x{static read_bytes(e,r){const a=new x;return a.buf=e.getUint32(r,!0),a.buf_len=e.getUint32(r+4,!0),a}static read_bytes_array(e,r,a){const u=[];for(let t=0;t<a;t++)u.push(x.read_bytes(e,r+8*t));return u}}const re=0,ne=1,H=2,G=2,O=3,B=4;class F{head_length(){return 24}name_length(){return this.dir_name.byteLength}write_head_bytes(e,r){e.setBigUint64(r,this.d_next,!0),e.setBigUint64(r+8,this.d_ino,!0),e.setUint32(r+16,this.dir_name.length,!0),e.setUint8(r+20,this.d_type)}write_name_bytes(e,r,a){e.set(this.dir_name.slice(0,Math.min(this.dir_name.byteLength,a)),r)}constructor(e,r,a,u){const t=new TextEncoder().encode(a);this.d_next=e,this.d_ino=r,this.d_namlen=t.byteLength,this.d_type=u,this.dir_name=t}}const se=1;class k{write_bytes(e,r){e.setUint8(r,this.fs_filetype),e.setUint16(r+2,this.fs_flags,!0),e.setBigUint64(r+8,this.fs_rights_base,!0),e.setBigUint64(r+16,this.fs_rights_inherited,!0)}constructor(e,r){this.fs_rights_base=0n,this.fs_rights_inherited=0n,this.fs_filetype=e,this.fs_flags=r}}const L=1,T=2,v=4,Y=8;class V{write_bytes(e,r){e.setBigUint64(r,this.dev,!0),e.setBigUint64(r+8,this.ino,!0),e.setUint8(r+16,this.filetype),e.setBigUint64(r+24,this.nlink,!0),e.setBigUint64(r+32,this.size,!0),e.setBigUint64(r+38,this.atim,!0),e.setBigUint64(r+46,this.mtim,!0),e.setBigUint64(r+52,this.ctim,!0)}constructor(e,r,a){this.dev=0n,this.nlink=0n,this.atim=0n,this.mtim=0n,this.ctim=0n,this.ino=e,this.filetype=r,this.size=a}}const ie=0,fe=1;class z{static read_bytes(e,r){return new z(e.getBigUint64(r,!0),e.getUint8(r+8),e.getUint32(r+16,!0),e.getBigUint64(r+24,!0),e.getUint16(r+36,!0))}constructor(e,r,a,u,t){this.userdata=e,this.eventtype=r,this.clockid=a,this.timeout=u,this.flags=t}}class ae{write_bytes(e,r){e.setBigUint64(r,this.userdata,!0),e.setUint16(r+8,this.error,!0),e.setUint8(r+10,this.eventtype)}constructor(e,r,a){this.userdata=e,this.error=r,this.eventtype=a}}const oe=0;class le{write_bytes(e,r){e.setUint32(r,this.pr_name.byteLength,!0)}constructor(e){this.pr_name=new TextEncoder().encode(e)}}class M{static dir(e){const r=new M;return r.tag=oe,r.inner=new le(e),r}write_bytes(e,r){e.setUint32(r,this.tag,!0),this.inner.write_bytes(e,r+4)}}let ue=class{enable(e){this.log=_e(e===void 0?!0:e,this.prefix)}get enabled(){return this.isEnabled}constructor(e){this.isEnabled=e,this.prefix="wasi:",this.enable(e)}};function _e(d,e){return d?console.log.bind(console,"%c%s","color: #265BA0",e):()=>{}}const E=new ue(!1);class K extends Error{constructor(e){super("exit with exit code "+e),this.code=e}}let de=class{start(e){this.inst=e;try{return e.exports._start(),0}catch(r){if(r instanceof K)return r.code;throw r}}initialize(e){this.inst=e,e.exports._initialize&&e.exports._initialize()}constructor(e,r,a,u={}){this.args=[],this.env=[],this.fds=[],E.enable(u.debug),this.args=e,this.env=r,this.fds=a;const t=this;this.wasiImport={args_sizes_get(n,s){const i=new DataView(t.inst.exports.memory.buffer);i.setUint32(n,t.args.length,!0);let f=0;for(const o of t.args)f+=o.length+1;return i.setUint32(s,f,!0),E.log(i.getUint32(n,!0),i.getUint32(s,!0)),0},args_get(n,s){const i=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer),o=s;for(let l=0;l<t.args.length;l++){i.setUint32(n,s,!0),n+=4;const _=new TextEncoder().encode(t.args[l]);f.set(_,s),i.setUint8(s+_.length,0),s+=_.length+1}return E.enabled&&E.log(new TextDecoder("utf-8").decode(f.slice(o,s))),0},environ_sizes_get(n,s){const i=new DataView(t.inst.exports.memory.buffer);i.setUint32(n,t.env.length,!0);let f=0;for(const o of t.env)f+=new TextEncoder().encode(o).length+1;return i.setUint32(s,f,!0),E.log(i.getUint32(n,!0),i.getUint32(s,!0)),0},environ_get(n,s){const i=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer),o=s;for(let l=0;l<t.env.length;l++){i.setUint32(n,s,!0),n+=4;const _=new TextEncoder().encode(t.env[l]);f.set(_,s),i.setUint8(s+_.length,0),s+=_.length+1}return E.enabled&&E.log(new TextDecoder("utf-8").decode(f.slice(o,s))),0},clock_res_get(n,s){let i;switch(n){case 1:{i=5000n;break}case 0:{i=1000000n;break}default:return 52}return new DataView(t.inst.exports.memory.buffer).setBigUint64(s,i,!0),0},clock_time_get(n,s,i){const f=new DataView(t.inst.exports.memory.buffer);if(n===0)f.setBigUint64(i,BigInt(new Date().getTime())*1000000n,!0);else if(n==1){let o;try{o=BigInt(Math.round(performance.now()*1e6))}catch{o=0n}f.setBigUint64(i,o,!0)}else f.setBigUint64(i,0n,!0);return 0},fd_advise(n,s,i,f){return t.fds[n]!=null?0:8},fd_allocate(n,s,i){return t.fds[n]!=null?t.fds[n].fd_allocate(s,i):8},fd_close(n){if(t.fds[n]!=null){const s=t.fds[n].fd_close();return t.fds[n]=void 0,s}else return 8},fd_datasync(n){return t.fds[n]!=null?t.fds[n].fd_sync():8},fd_fdstat_get(n,s){if(t.fds[n]!=null){const{ret:i,fdstat:f}=t.fds[n].fd_fdstat_get();return f?.write_bytes(new DataView(t.inst.exports.memory.buffer),s),i}else return 8},fd_fdstat_set_flags(n,s){return t.fds[n]!=null?t.fds[n].fd_fdstat_set_flags(s):8},fd_fdstat_set_rights(n,s,i){return t.fds[n]!=null?t.fds[n].fd_fdstat_set_rights(s,i):8},fd_filestat_get(n,s){if(t.fds[n]!=null){const{ret:i,filestat:f}=t.fds[n].fd_filestat_get();return f?.write_bytes(new DataView(t.inst.exports.memory.buffer),s),i}else return 8},fd_filestat_set_size(n,s){return t.fds[n]!=null?t.fds[n].fd_filestat_set_size(s):8},fd_filestat_set_times(n,s,i,f){return t.fds[n]!=null?t.fds[n].fd_filestat_set_times(s,i,f):8},fd_pread(n,s,i,f,o){const l=new DataView(t.inst.exports.memory.buffer),_=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const h=D.read_bytes_array(l,s,i);let R=0;for(const c of h){const{ret:p,data:y}=t.fds[n].fd_pread(c.buf_len,f);if(p!=0)return l.setUint32(o,R,!0),p;if(_.set(y,c.buf),R+=y.length,f+=BigInt(y.length),y.length!=c.buf_len)break}return l.setUint32(o,R,!0),0}else return 8},fd_prestat_get(n,s){const i=new DataView(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const{ret:f,prestat:o}=t.fds[n].fd_prestat_get();return o?.write_bytes(i,s),f}else return 8},fd_prestat_dir_name(n,s,i){if(t.fds[n]!=null){const{ret:f,prestat:o}=t.fds[n].fd_prestat_get();if(o==null)return f;const l=o.inner.pr_name;return new Uint8Array(t.inst.exports.memory.buffer).set(l.slice(0,i),s),l.byteLength>i?37:0}else return 8},fd_pwrite(n,s,i,f,o){const l=new DataView(t.inst.exports.memory.buffer),_=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const h=x.read_bytes_array(l,s,i);let R=0;for(const c of h){const p=_.slice(c.buf,c.buf+c.buf_len),{ret:y,nwritten:A}=t.fds[n].fd_pwrite(p,f);if(y!=0)return l.setUint32(o,R,!0),y;if(R+=A,f+=BigInt(A),A!=p.byteLength)break}return l.setUint32(o,R,!0),0}else return 8},fd_read(n,s,i,f){const o=new DataView(t.inst.exports.memory.buffer),l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const _=D.read_bytes_array(o,s,i);let h=0;for(const R of _){const{ret:c,data:p}=t.fds[n].fd_read(R.buf_len);if(c!=0)return o.setUint32(f,h,!0),c;if(l.set(p,R.buf),h+=p.length,p.length!=R.buf_len)break}return o.setUint32(f,h,!0),0}else return 8},fd_readdir(n,s,i,f,o){const l=new DataView(t.inst.exports.memory.buffer),_=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){let h=0;for(;;){const{ret:R,dirent:c}=t.fds[n].fd_readdir_single(f);if(R!=0)return l.setUint32(o,h,!0),R;if(c==null)break;if(i-h<c.head_length()){h=i;break}const p=new ArrayBuffer(c.head_length());if(c.write_head_bytes(new DataView(p),0),_.set(new Uint8Array(p).slice(0,Math.min(p.byteLength,i-h)),s),s+=c.head_length(),h+=c.head_length(),i-h<c.name_length()){h=i;break}c.write_name_bytes(_,s,i-h),s+=c.name_length(),h+=c.name_length(),f=c.d_next}return l.setUint32(o,h,!0),0}else return 8},fd_renumber(n,s){if(t.fds[n]!=null&&t.fds[s]!=null){const i=t.fds[s].fd_close();return i!=0?i:(t.fds[s]=t.fds[n],t.fds[n]=void 0,0)}else return 8},fd_seek(n,s,i,f){const o=new DataView(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const{ret:l,offset:_}=t.fds[n].fd_seek(s,i);return o.setBigInt64(f,_,!0),l}else return 8},fd_sync(n){return t.fds[n]!=null?t.fds[n].fd_sync():8},fd_tell(n,s){const i=new DataView(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const{ret:f,offset:o}=t.fds[n].fd_tell();return i.setBigUint64(s,o,!0),f}else return 8},fd_write(n,s,i,f){const o=new DataView(t.inst.exports.memory.buffer),l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const _=x.read_bytes_array(o,s,i);let h=0;for(const R of _){const c=l.slice(R.buf,R.buf+R.buf_len),{ret:p,nwritten:y}=t.fds[n].fd_write(c);if(p!=0)return o.setUint32(f,h,!0),p;if(h+=y,y!=c.byteLength)break}return o.setUint32(f,h,!0),0}else return 8},path_create_directory(n,s,i){const f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const o=new TextDecoder("utf-8").decode(f.slice(s,s+i));return t.fds[n].path_create_directory(o)}else return 8},path_filestat_get(n,s,i,f,o){const l=new DataView(t.inst.exports.memory.buffer),_=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const h=new TextDecoder("utf-8").decode(_.slice(i,i+f)),{ret:R,filestat:c}=t.fds[n].path_filestat_get(s,h);return c?.write_bytes(l,o),R}else return 8},path_filestat_set_times(n,s,i,f,o,l,_){const h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const R=new TextDecoder("utf-8").decode(h.slice(i,i+f));return t.fds[n].path_filestat_set_times(s,R,o,l,_)}else return 8},path_link(n,s,i,f,o,l,_){const h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null&&t.fds[o]!=null){const R=new TextDecoder("utf-8").decode(h.slice(i,i+f)),c=new TextDecoder("utf-8").decode(h.slice(l,l+_)),{ret:p,inode_obj:y}=t.fds[n].path_lookup(R,s);return y==null?p:t.fds[o].path_link(c,y,!1)}else return 8},path_open(n,s,i,f,o,l,_,h,R){const c=new DataView(t.inst.exports.memory.buffer),p=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const y=new TextDecoder("utf-8").decode(p.slice(i,i+f));E.log(y);const{ret:A,fd_obj:ee}=t.fds[n].path_open(s,y,o,l,_,h);if(A!=0)return A;t.fds.push(ee);const te=t.fds.length-1;return c.setUint32(R,te,!0),0}else return 8},path_readlink(n,s,i,f,o,l){const _=new DataView(t.inst.exports.memory.buffer),h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const R=new TextDecoder("utf-8").decode(h.slice(s,s+i));E.log(R);const{ret:c,data:p}=t.fds[n].path_readlink(R);if(p!=null){const y=new TextEncoder().encode(p);if(y.length>o)return _.setUint32(l,0,!0),8;h.set(y,f),_.setUint32(l,y.length,!0)}return c}else return 8},path_remove_directory(n,s,i){const f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const o=new TextDecoder("utf-8").decode(f.slice(s,s+i));return t.fds[n].path_remove_directory(o)}else return 8},path_rename(n,s,i,f,o,l){const _=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null&&t.fds[f]!=null){const h=new TextDecoder("utf-8").decode(_.slice(s,s+i)),R=new TextDecoder("utf-8").decode(_.slice(o,o+l));let{ret:c,inode_obj:p}=t.fds[n].path_unlink(h);if(p==null)return c;if(c=t.fds[f].path_link(R,p,!0),c!=0&&t.fds[n].path_link(h,p,!0)!=0)throw"path_link should always return success when relinking an inode back to the original place";return c}else return 8},path_symlink(n,s,i,f,o){const l=new Uint8Array(t.inst.exports.memory.buffer);return t.fds[i]!=null?(new TextDecoder("utf-8").decode(l.slice(n,n+s)),new TextDecoder("utf-8").decode(l.slice(f,f+o)),58):8},path_unlink_file(n,s,i){const f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const o=new TextDecoder("utf-8").decode(f.slice(s,s+i));return t.fds[n].path_unlink_file(o)}else return 8},poll_oneoff(n,s,i){if(i===0)return 28;if(i>1)return E.log("poll_oneoff: only a single subscription is supported"),58;const f=new DataView(t.inst.exports.memory.buffer),o=z.read_bytes(f,n),l=o.eventtype,_=o.clockid,h=o.timeout;if(l!==ie)return E.log("poll_oneoff: only clock subscriptions are supported"),58;let R;if(_===1)R=()=>BigInt(Math.round(performance.now()*1e6));else if(_===0)R=()=>BigInt(new Date().getTime())*1000000n;else return 28;const c=(o.flags&fe)!==0?h:R()+h;for(;c>R(););return new ae(o.userdata,0,l).write_bytes(f,s),0},proc_exit(n){throw new K(n)},proc_raise(n){throw"raised signal "+n},sched_yield(){},random_get(n,s){const i=new Uint8Array(t.inst.exports.memory.buffer).subarray(n,n+s);if("crypto"in globalThis&&(typeof SharedArrayBuffer>"u"||!(t.inst.exports.memory.buffer instanceof SharedArrayBuffer)))for(let f=0;f<s;f+=65536)crypto.getRandomValues(i.subarray(f,f+65536));else for(let f=0;f<s;f++)i[f]=Math.random()*256|0},sock_recv(n,s,i){throw"sockets not supported"},sock_send(n,s,i){throw"sockets not supported"},sock_shutdown(n,s){throw"sockets not supported"},sock_accept(n,s){throw"sockets not supported"}}}};class j{fd_allocate(e,r){return 58}fd_close(){return 0}fd_fdstat_get(){return{ret:58,fdstat:null}}fd_fdstat_set_flags(e){return 58}fd_fdstat_set_rights(e,r){return 58}fd_filestat_get(){return{ret:58,filestat:null}}fd_filestat_set_size(e){return 58}fd_filestat_set_times(e,r,a){return 58}fd_pread(e,r){return{ret:58,data:new Uint8Array}}fd_prestat_get(){return{ret:58,prestat:null}}fd_pwrite(e,r){return{ret:58,nwritten:0}}fd_read(e){return{ret:58,data:new Uint8Array}}fd_readdir_single(e){return{ret:58,dirent:null}}fd_seek(e,r){return{ret:58,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:58,offset:0n}}fd_write(e){return{ret:58,nwritten:0}}path_create_directory(e){return 58}path_filestat_get(e,r){return{ret:58,filestat:null}}path_filestat_set_times(e,r,a,u,t){return 58}path_link(e,r,a){return 58}path_unlink(e){return{ret:58,inode_obj:null}}path_lookup(e,r){return{ret:58,inode_obj:null}}path_open(e,r,a,u,t,n){return{ret:54,fd_obj:null}}path_readlink(e){return{ret:58,data:null}}path_remove_directory(e){return 58}path_rename(e,r,a){return 58}path_unlink_file(e){return 58}}class S{static issue_ino(){return S.next_ino++}static root_ino(){return 0n}constructor(){this.ino=S.issue_ino()}}S.next_ino=1n;class X extends j{fd_allocate(e,r){if(!(this.file.size>e+r)){const a=new Uint8Array(Number(e+r));a.set(this.file.data,0),this.file.data=a}return 0}fd_fdstat_get(){return{ret:0,fdstat:new k(B,0)}}fd_filestat_set_size(e){if(this.file.size>e)this.file.data=new Uint8Array(this.file.data.buffer.slice(0,Number(e)));else{const r=new Uint8Array(Number(e));r.set(this.file.data,0),this.file.data=r}return 0}fd_read(e){const r=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(e)));return this.file_pos+=BigInt(r.length),{ret:0,data:r}}fd_pread(e,r){return{ret:0,data:this.file.data.slice(Number(r),Number(r+BigInt(e)))}}fd_seek(e,r){let a;switch(r){case re:a=e;break;case ne:a=this.file_pos+e;break;case H:a=BigInt(this.file.data.byteLength)+e;break;default:return{ret:28,offset:0n}}return a<0?{ret:28,offset:0n}:(this.file_pos=a,{ret:0,offset:this.file_pos})}fd_tell(){return{ret:0,offset:this.file_pos}}fd_write(e){if(this.file.readonly)return{ret:8,nwritten:0};if(this.file_pos+BigInt(e.byteLength)>this.file.size){const r=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(e.byteLength))),this.file.data.set(r)}return this.file.data.set(e,Number(this.file_pos)),this.file_pos+=BigInt(e.byteLength),{ret:0,nwritten:e.byteLength}}fd_pwrite(e,r){if(this.file.readonly)return{ret:8,nwritten:0};if(r+BigInt(e.byteLength)>this.file.size){const a=this.file.data;this.file.data=new Uint8Array(Number(r+BigInt(e.byteLength))),this.file.data.set(a)}return this.file.data.set(e,Number(r)),{ret:0,nwritten:e.byteLength}}fd_filestat_get(){return{ret:0,filestat:this.file.stat()}}constructor(e){super(),this.file_pos=0n,this.file=e}}class J extends j{fd_seek(e,r){return{ret:8,offset:0n}}fd_tell(){return{ret:8,offset:0n}}fd_allocate(e,r){return 8}fd_fdstat_get(){return{ret:0,fdstat:new k(O,0)}}fd_readdir_single(e){if(E.enabled&&(E.log("readdir_single",e),E.log(e,this.dir.contents.keys())),e==0n)return{ret:0,dirent:new F(1n,this.dir.ino,".",O)};if(e==1n)return{ret:0,dirent:new F(2n,this.dir.parent_ino(),"..",O)};if(e>=BigInt(this.dir.contents.size)+2n)return{ret:0,dirent:null};const[r,a]=Array.from(this.dir.contents.entries())[Number(e-2n)];return{ret:0,dirent:new F(e+1n,a.ino,r,a.stat().filetype)}}path_filestat_get(e,r){const{ret:a,path:u}=b.from(r);if(u==null)return{ret:a,filestat:null};const{ret:t,entry:n}=this.dir.get_entry_for_path(u);return n==null?{ret:t,filestat:null}:{ret:0,filestat:n.stat()}}path_lookup(e,r){const{ret:a,path:u}=b.from(e);if(u==null)return{ret:a,inode_obj:null};const{ret:t,entry:n}=this.dir.get_entry_for_path(u);return n==null?{ret:t,inode_obj:null}:{ret:0,inode_obj:n}}path_open(e,r,a,u,t,n){const{ret:s,path:i}=b.from(r);if(i==null)return{ret:s,fd_obj:null};let{ret:f,entry:o}=this.dir.get_entry_for_path(i);if(o==null){if(f!=44)return{ret:f,fd_obj:null};if((a&L)==L){const{ret:l,entry:_}=this.dir.create_entry_for_path(r,(a&T)==T);if(_==null)return{ret:l,fd_obj:null};o=_}else return{ret:44,fd_obj:null}}else if((a&v)==v)return{ret:20,fd_obj:null};return(a&T)==T&&o.stat().filetype!==O?{ret:54,fd_obj:null}:o.path_open(a,u,n)}path_create_directory(e){return this.path_open(0,e,L|T,0n,0n,0).ret}path_link(e,r,a){const{ret:u,path:t}=b.from(e);if(t==null)return u;if(t.is_dir)return 44;const{ret:n,parent_entry:s,filename:i,entry:f}=this.dir.get_parent_dir_and_entry_for_path(t,!0);if(s==null||i==null)return n;if(f!=null){const o=r.stat().filetype==O,l=f.stat().filetype==O;if(o&&l)if(a&&f instanceof U){if(f.contents.size!=0)return 55}else return 20;else{if(o&&!l)return 54;if(!o&&l)return 31;if(!(r.stat().filetype==B&&f.stat().filetype==B))return 20}}return!a&&r.stat().filetype==O?63:(s.contents.set(i,r),0)}path_unlink(e){const{ret:r,path:a}=b.from(e);if(a==null)return{ret:r,inode_obj:null};const{ret:u,parent_entry:t,filename:n,entry:s}=this.dir.get_parent_dir_and_entry_for_path(a,!0);return t==null||n==null?{ret:u,inode_obj:null}:s==null?{ret:44,inode_obj:null}:(t.contents.delete(n),{ret:0,inode_obj:s})}path_unlink_file(e){const{ret:r,path:a}=b.from(e);if(a==null)return r;const{ret:u,parent_entry:t,filename:n,entry:s}=this.dir.get_parent_dir_and_entry_for_path(a,!1);return t==null||n==null||s==null?u:s.stat().filetype===O?31:(t.contents.delete(n),0)}path_remove_directory(e){const{ret:r,path:a}=b.from(e);if(a==null)return r;const{ret:u,parent_entry:t,filename:n,entry:s}=this.dir.get_parent_dir_and_entry_for_path(a,!1);return t==null||n==null||s==null?u:!(s instanceof U)||s.stat().filetype!==O?54:s.contents.size!==0?55:t.contents.delete(n)?0:44}fd_filestat_get(){return{ret:0,filestat:this.dir.stat()}}fd_filestat_set_size(e){return 8}fd_read(e){return{ret:8,data:new Uint8Array}}fd_pread(e,r){return{ret:8,data:new Uint8Array}}fd_write(e){return{ret:8,nwritten:0}}fd_pwrite(e,r){return{ret:8,nwritten:0}}constructor(e){super(),this.dir=e}}class ce extends J{fd_prestat_get(){return{ret:0,prestat:M.dir(this.prestat_name)}}constructor(e,r){super(new U(r)),this.prestat_name=e}}class g extends S{path_open(e,r,a){if(this.readonly&&(r&BigInt(64))==BigInt(64))return{ret:63,fd_obj:null};if((e&Y)==Y){if(this.readonly)return{ret:63,fd_obj:null};this.data=new Uint8Array([])}const u=new X(this);return a&se&&u.fd_seek(0n,H),{ret:0,fd_obj:u}}get size(){return BigInt(this.data.byteLength)}stat(){return new V(this.ino,B,this.size)}constructor(e,r){super(),this.data=new Uint8Array(e),this.readonly=!!r?.readonly}}let b=class q{static from(e){const r=new q;if(r.is_dir=e.endsWith("/"),e.startsWith("/"))return{ret:76,path:null};if(e.includes("\0"))return{ret:28,path:null};for(const a of e.split("/"))if(!(a===""||a===".")){if(a===".."){if(r.parts.pop()==null)return{ret:76,path:null};continue}r.parts.push(a)}return{ret:0,path:r}}to_path_string(){let e=this.parts.join("/");return this.is_dir&&(e+="/"),e}constructor(){this.parts=[],this.is_dir=!1}};class U extends S{parent_ino(){return this.parent==null?S.root_ino():this.parent.ino}path_open(e,r,a){return{ret:0,fd_obj:new J(this)}}stat(){return new V(this.ino,O,0n)}get_entry_for_path(e){let r=this;for(const a of e.parts){if(!(r instanceof U))return{ret:54,entry:null};const u=r.contents.get(a);if(u!==void 0)r=u;else return E.log(a),{ret:44,entry:null}}return e.is_dir&&r.stat().filetype!=O?{ret:54,entry:null}:{ret:0,entry:r}}get_parent_dir_and_entry_for_path(e,r){const a=e.parts.pop();if(a===void 0)return{ret:28,parent_entry:null,filename:null,entry:null};const{ret:u,entry:t}=this.get_entry_for_path(e);if(t==null)return{ret:u,parent_entry:null,filename:null,entry:null};if(!(t instanceof U))return{ret:54,parent_entry:null,filename:null,entry:null};const n=t.contents.get(a);return n===void 0?r?{ret:0,parent_entry:t,filename:a,entry:null}:{ret:44,parent_entry:null,filename:null,entry:null}:e.is_dir&&n.stat().filetype!=O?{ret:54,parent_entry:null,filename:null,entry:null}:{ret:0,parent_entry:t,filename:a,entry:n}}create_entry_for_path(e,r){const{ret:a,path:u}=b.from(e);if(u==null)return{ret:a,entry:null};let{ret:t,parent_entry:n,filename:s,entry:i}=this.get_parent_dir_and_entry_for_path(u,!0);if(n==null||s==null)return{ret:t,entry:null};if(i!=null)return{ret:20,entry:null};E.log("create",u);let f;return r?f=new U(new Map):f=new g(new ArrayBuffer(0)),n.contents.set(s,f),i=f,{ret:0,entry:i}}constructor(e){super(),this.parent=null,e instanceof Array?this.contents=new Map(e):this.contents=e;for(const r of this.contents.values())r instanceof U&&(r.parent=this)}}class I extends j{fd_filestat_get(){return{ret:0,filestat:new V(this.ino,G,BigInt(0))}}fd_fdstat_get(){const e=new k(G,0);return e.fs_rights_base=BigInt(64),{ret:0,fdstat:e}}fd_write(e){return this.write(e),{ret:0,nwritten:e.byteLength}}static lineBuffered(e){const r=new TextDecoder("utf-8",{fatal:!1});let a="";return new I(u=>{a+=r.decode(u,{stream:!0});const t=a.split(`
`);for(const[n,s]of t.entries())n<t.length-1?e(s):a=s})}constructor(e){super(),this.ino=S.issue_ino(),this.write=e}}const m=["pandoc.wasm","+RTS","-H64m","-RTS"],he=[];new g(new Uint8Array,{readonly:!0});new g(new Uint8Array,{readonly:!1});new g(new Uint8Array,{readonly:!1});new g(new Uint8Array,{readonly:!1});const w=new Map,Re=[new X(new g(new Uint8Array,{readonly:!0})),I.lineBuffered(d=>console.log(`[WASI stdout] ${d}`)),I.lineBuffered(d=>console.warn(`[WASI stderr] ${d}`)),new ce("/",w)],pe={debug:!1},$=new de(m,he,Re,pe),{instance:N}=await WebAssembly.instantiateStreaming(fetch("/convert/wasm/pandoc.wasm"),{wasi_snapshot_preview1:$.wasiImport});$.initialize(N);N.exports.__wasm_call_ctors();function C(){return new DataView(N.exports.memory.buffer)}const Q=N.exports.malloc(4);C().setUint32(Q,m.length,!0);const W=N.exports.malloc(4*(m.length+1));for(let d=0;d<m.length;++d){const e=N.exports.malloc(m[d].length+1);new TextEncoder().encodeInto(m[d],new Uint8Array(N.exports.memory.buffer,e,m[d].length)),C().setUint8(e+m[d].length,0),C().setUint32(W+4*d,e,!0)}C().setUint32(W+4*m.length,0,!0);const Z=N.exports.malloc(4);C().setUint32(Z,W,!0);N.exports.hs_init_with_rtsopts(Q,Z);async function Ne(d){const e=JSON.stringify(d),r=new TextEncoder().encode(e),a=N.exports.malloc(r.length);new Uint8Array(N.exports.memory.buffer,a,r.length).set(r),w.clear();const u=new g(new Uint8Array,{readonly:!1}),t=new g(new Uint8Array,{readonly:!1});w.set("stdout",u),w.set("stderr",t),N.exports.query(a,r.length);const n=new TextDecoder("utf-8",{fatal:!0}).decode(t.data);n&&console.log(n);const s=new TextDecoder("utf-8",{fatal:!0}).decode(u.data);return JSON.parse(s)}async function ge(d,e,r){const a=JSON.stringify(d),u=new TextEncoder().encode(a),t=N.exports.malloc(u.length);new Uint8Array(N.exports.memory.buffer,t,u.length).set(u),w.clear();const n=new g(new Uint8Array,{readonly:!0}),s=new g(new Uint8Array,{readonly:!1}),i=new g(new Uint8Array,{readonly:!1}),f=new g(new Uint8Array,{readonly:!1});w.set("stdin",n),w.set("stdout",s),w.set("stderr",i),w.set("warnings",f);for(const _ in r)await P(_,r[_],!0);if(d["output-file"]&&await P(d["output-file"],new Blob,!1),d["extract-media"]&&await P(d["extract-media"],new Blob,!1),e&&(n.data=new TextEncoder().encode(e)),N.exports.convert(t,u.length),d["output-file"]&&(r[d["output-file"]]=new Blob([w.get(d["output-file"]).data])),d["extract-media"]){const _=w.get(d["extract-media"]);_&&_.data&&_.data.length>0&&(r[d["extract-media"]]=new Blob([_.data],{type:"application/zip"}))}const o=new TextDecoder("utf-8",{fatal:!0}).decode(f.data);let l=[];return o&&(l=JSON.parse(o)),{stdout:new TextDecoder("utf-8",{fatal:!0}).decode(s.data),stderr:new TextDecoder("utf-8",{fatal:!0}).decode(i.data),warnings:l}}async function P(d,e,r){const a=await e.arrayBuffer(),u=new g(new Uint8Array(a),{readonly:r});w.set(d,u)}export{ge as convert,Ne as query};
